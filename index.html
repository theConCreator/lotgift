<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Slot Machine Telegram Gifts</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/lottie-web/build/player/lottie_light.min.js"></script>
<style>
html, body {margin:0; padding:0; overflow:hidden; height:100%; background:#111; font-family:sans-serif;}
.app {display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh;}
.machine-wrap {position:relative; width:440px; height:440px; display:flex; justify-content:center; align-items:center;}
.reels {position:absolute; display:flex; gap:14px; z-index:0;}
.slot-window {width:110px; height:110px; overflow:hidden; border-radius:12px; background:#000; display:flex; align-items:center; justify-content:center; position:relative;}
.slot-strip {will-change: transform;}
.slot-cell {width:110px; height:110px; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:14px; text-align:center;}
.spin-btn {margin-top:20px; padding:10px 28px; border-radius:12px; border:0; background:linear-gradient(90deg,#7c3aed,#ec4899); color:white; font-weight:700; font-size:18px; cursor:pointer;}
.spin-btn[disabled]{opacity:0.45; cursor:not-allowed;}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState, useEffect, useRef} = React;

// ÐŸÐ¾Ð´Ð°Ñ€ÐºÐ¸
const gifts = [
  {name:"Desk Calendar", file:"./assets/gifts/Desk Calendar.json"},
  {name:"B-Day Candle", file:"./assets/gifts/B-Day Candle.json"},
  {name:"Lol Pop", file:"./assets/gifts/Lol Pop.json"}
];

const ITEM_SIZE = 110;
const SPEED_PX_PER_MS = 1.5;
const STOP_TIMES = [1000, 1500, 2000];

// ÐšÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚ Ð±Ð°Ñ€Ð°Ð±Ð°Ð½Ð°
function Reel({reelIndex, spinning, finalGiftIndex, stopTime, onReelStop}) {
  const stripRef = useRef(null);
  const posRef = useRef(0);
  const runningRef = useRef(false);
  const rafRef = useRef(null);
  const lastTsRef = useRef(null);
  const cellsRef = useRef([]);

  useEffect(()=>{
    if(!spinning) return;
    runningRef.current=true;
    function step(ts){
      if(!runningRef.current) return;
      if(lastTsRef.current==null) lastTsRef.current=ts;
      const dt = ts - lastTsRef.current;
      lastTsRef.current = ts;
      posRef.current += SPEED_PX_PER_MS*dt;
      const relOffset = posRef.current % (ITEM_SIZE*gifts.length);
      if(stripRef.current) stripRef.current.style.transform = `translateY(-${relOffset}px)`;
      rafRef.current=requestAnimationFrame(step);
    }
    rafRef.current=requestAnimationFrame(step);

    const timer = setTimeout(()=>{
      runningRef.current=false;
      if(rafRef.current) cancelAnimationFrame(rafRef.current);
      const loops = 3;
      const targetIndex = finalGiftIndex + loops*gifts.length;
      const targetOffset = targetIndex*ITEM_SIZE;
      if(stripRef.current){
        stripRef.current.style.transition='transform 0.8s ease-out';
        stripRef.current.style.transform = `translateY(-${targetOffset}px)`;
        stripRef.current.addEventListener('transitionend', ()=>{
          stripRef.current.style.transition='';
          posRef.current = finalGiftIndex*ITEM_SIZE;
          stripRef.current.style.transform = `translateY(-${posRef.current}px)`;

          // Ð¿Ñ€Ð¾Ð¸Ð³Ñ€Ñ‹Ð²Ð°ÐµÐ¼ Lottie ÐµÑÐ»Ð¸ Ñ„Ð°Ð¹Ð» Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½
          const cell = cellsRef.current[finalGiftIndex];
          if(cell){
            try{
              const anim = lottie.loadAnimation({
                container: cell,
                renderer: 'svg',
                loop: false,
                autoplay: true,
                path: gifts[finalGiftIndex].file
              });
              anim.addEventListener('complete', ()=>anim.destroy());
            }catch(e){
              // ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ JSON, Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚ÐµÐºÑÑ‚
              console.warn("Lottie Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ð»ÑÑ:", e);
            }
          }
          onReelStop && onReelStop(reelIndex);
        }, {once:true});
      }
    }, stopTime);

    return ()=>clearTimeout(timer);
  }, [spinning]);

  return (
    <div className="slot-window">
      <div className="slot-strip" ref={stripRef}>
        {gifts.map((gift,i)=>(
          <div key={i} className="slot-cell" ref={el=>cellsRef.current[i]=el}>
            {gift.name}
          </div>
        ))}
      </div>
    </div>
  );
}

// ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ App
function App(){
  const [spinning,setSpinning]=useState(false);
  const [finals,setFinals]=useState([0,0,0]);
  const machineRef = useRef(null);
  const machineAnim = useRef(null);
  const stoppedCount = useRef(0);

  useEffect(()=>{
    if(machineRef.current){
      try{
        machineAnim.current = lottie.loadAnimation({container:machineRef.current, renderer:'svg', loop:false, autoplay:false, path:'./assets/777.json'});
      }catch(e){console.warn("ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚ Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ð»ÑÑ:",e);}
    }
  },[]);

  function handleReelStop(i){
    stoppedCount.current += 1;
    if(stoppedCount.current>=3){
      setSpinning(false);
      stoppedCount.current=0;
      if(finals[0]===finals[1] && finals[1]===finals[2]){
        setTimeout(()=>alert(`ðŸŽ‰ Ð’Ñ‹ Ð²Ñ‹Ð¸Ð³Ñ€Ð°Ð»Ð¸: ${gifts[finals[0]].name}`),100);
      }
    }
  }

  function spin(){
    if(spinning) return;
    const res = [
      Math.floor(Math.random()*gifts.length),
      Math.floor(Math.random()*gifts.length),
      Math.floor(Math.random()*gifts.length)
    ];
    setFinals(res);
    stoppedCount.current=0;
    setSpinning(true);
    if(machineAnim.current){
      try{ machineAnim.current.goToAndStop(0,true); machineAnim.current.play(); }catch(e){}
    }
  }

  return (
    <div className="app">
      <div className="machine-wrap">
        <div className="reels">
          {finals.map((f,i)=>(
            <Reel key={i} reelIndex={i} spinning={spinning} finalGiftIndex={f} stopTime={STOP_TIMES[i]} onReelStop={handleReelStop}/>
          ))}
        </div>
        <div style={{position:'absolute',inset:0,zIndex:60,pointerEvents:'none'}} ref={machineRef}></div>
      </div>
      <button className="spin-btn" onClick={spin} disabled={spinning}>{spinning?'ÐšÑ€ÑƒÑ‚Ð¸Ð¼...':'Spin ðŸŽ°'}</button>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
