<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Slot Machine — Telegram Gifts</title>
<script src="https://unpkg.com/lottie-web/build/player/lottie_light.min.js"></script>
<style>
  :root { --item-size:110px; }
  body { margin:0; background:#111; overflow:hidden; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; color:#fff; font-family:sans-serif; }
  .machine { width:560px; height:460px; position:relative; display:flex; align-items:center; justify-content:center; }
  .reels { position:absolute; z-index:200; display:flex; gap:16px; }
  .slot-window { width:var(--item-size); height:var(--item-size); overflow:hidden; border-radius:12px; background:#222; display:flex; align-items:center; justify-content:center; }
  .slot-strip { will-change:transform; }
  .slot-cell { width:var(--item-size); height:var(--item-size); display:flex; align-items:center; justify-content:center; position:relative; }
  .cell-svg>svg{width:100%;height:100%;}
  .cell-label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;}
  .machine-overlay{position:absolute;inset:0;z-index:900;pointer-events:none;display:flex;align-items:center;justify-content:center;}
  .controls{margin-top:12px;}
  button{padding:12px 28px;border:none;border-radius:10px;background:linear-gradient(90deg,#7c3aed,#ec4899);color:#fff;font-weight:bold;cursor:pointer;}
  button[disabled]{opacity:.5;cursor:not-allowed;}
</style>
</head>
<body>
  <div class="machine">
    <div class="reels" id="reels"></div>
    <div class="machine-overlay" id="machine-overlay"></div>
  </div>
  <div class="controls">
    <button id="spin" disabled>Загрузка...</button>
  </div>

<script>
const ITEM_SIZE=110, REEL_COUNT=3, REPEATS=30, STOP_DELAYS=[1000,1500,2000];
const SPEED=2, EXTRA=3, EASE=600;
const gifts=[{name:"Desk Calendar",file:"assets/gifts/Desk Calendar.json"},
             {name:"B-Day Candle",file:"assets/gifts/B-Day Candle.json"},
             {name:"Lol Pop",file:"assets/gifts/Lol Pop.json"}];
const reels=[], reelsEl=document.getElementById("reels"), spinBtn=document.getElementById("spin");
const machineOverlay=document.getElementById("machine-overlay"); let machineAnim=null;

async function preloadFrame(path){
  return new Promise(res=>{
    const tmp=document.createElement("div"); tmp.style.cssText="position:fixed;left:-9999px;top:-9999px;width:110px;height:110px";
    document.body.appendChild(tmp);
    let anim=lottie.loadAnimation({container:tmp,renderer:"svg",loop:false,autoplay:false,path});
    anim.addEventListener("DOMLoaded",()=>{
      anim.goToAndStop(0,true);
      setTimeout(()=>{res(tmp.innerHTML);anim.destroy();tmp.remove();},50);
    });
    setTimeout(()=>{try{anim.destroy();}catch{}tmp.remove();res(null)},4000);
  });
}

let staticSvgs=[];
async function init(){
  for(let g of gifts){staticSvgs.push(await preloadFrame(g.file));}
  for(let r=0;r<REEL_COUNT;r++){
    const win=document.createElement("div"); win.className="slot-window";
    const strip=document.createElement("div"); strip.className="slot-strip";
    const cells=[];
    for(let i=0;i<REPEATS;i++){
      for(let gi=0;gi<gifts.length;gi++){
        const cell=document.createElement("div"); cell.className="slot-cell";
        const svg=document.createElement("div"); svg.className="cell-svg";
        if(staticSvgs[gi]) svg.innerHTML=staticSvgs[gi];
        else {const lbl=document.createElement("div"); lbl.className="cell-label"; lbl.textContent=gifts[gi].name; cell.appendChild(lbl);}
        cell.appendChild(svg); strip.appendChild(cell); cells.push({el:cell,svg,gift:gi});
      }
    }
    win.appendChild(strip); reelsEl.appendChild(win);
    reels.push({strip,pos:0,running:false,raf:null,total:cells.length*ITEM_SIZE,cells});
  }
  // overlay machine anim
  machineAnim=lottie.loadAnimation({container:machineOverlay,renderer:"svg",loop:true,autoplay:true,path:"assets/777.json"});
  spinBtn.disabled=false; spinBtn.textContent="SPIN";
}

function startSpin(r){
  const reel=reels[r]; reel.running=true;
  let last=null;
  function loop(ts){if(!reel.running){last=null;return;}
    if(last==null) last=ts; const dt=ts-last; last=ts;
    reel.pos=(reel.pos+SPEED*dt)%reel.total;
    reel.strip.style.transform=`translateY(-${reel.pos}px)`;
    reel.raf=requestAnimationFrame(loop);}
  reel.raf=requestAnimationFrame(loop);
}

function stopSpin(r,final){
  return new Promise(res=>{
    const reel=reels[r]; reel.running=false; if(reel.raf) cancelAnimationFrame(reel.raf);
    const current=Math.floor(reel.pos/ITEM_SIZE), L=gifts.length, rel=((current%L)+L)%L;
    let delta=(final-rel+L)%L; if(delta===0) delta=L;
    const targetIndex=current+delta+EXTRA*L, targetPos=targetIndex*ITEM_SIZE, start=reel.pos, t0=performance.now();
    function ease(now){const t=Math.min(1,(now-t0)/EASE), e=1-Math.pow(1-t,3);
      reel.pos=start+(targetPos-start)*e; reel.strip.style.transform=`translateY(-${reel.pos%reel.total}px)`;
      if(t<1) reel.raf=requestAnimationFrame(ease); else{reel.pos=(targetIndex%reel.cells.length)*ITEM_SIZE;
        reel.strip.style.transform=`translateY(-${reel.pos}px)`; res();}}
    reel.raf=requestAnimationFrame(ease);
  });
}

let spinning=false;
async function spin(){
  if(spinning)return; spinning=true; spinBtn.disabled=true;
  if(machineAnim) machineAnim.stop(); // ОСТАНАВЛИВАЕМ АВТОМАТ
  const finals=Array.from({length:REEL_COUNT},()=>Math.floor(Math.random()*gifts.length));
  for(let r=0;r<REEL_COUNT;r++) startSpin(r);
  for(let r=0;r<REEL_COUNT;r++){await new Promise(rs=>setTimeout(rs,STOP_DELAYS[r])); await stopSpin(r,finals[r]);}
  if(machineAnim) machineAnim.play(); // ВКЛЮЧАЕМ ПОСЛЕ ОСТАНОВКИ
  spinBtn.disabled=false; spinning=false;
}
spinBtn.addEventListener("click",spin);
init();
</script>
</body>
</html>
