<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Slot Machine Gifts</title>
<script src="https://unpkg.com/lottie-web/build/player/lottie_light.min.js"></script>
<style>
  :root {
    --cell-width: 100px;
    --aspect: 1; /* –∫–≤–∞–¥—Ä–∞—Ç –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞, –±—É–¥–µ–º —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ CONFIG */
    --cell-height: calc(var(--cell-width) * var(--aspect));
    --visible-cells: 3; /* —Å–∫–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–∏–¥–Ω–æ –≤ –æ–∫–Ω–µ */
    --gap: 20px;
  }
  body {
    margin:0;
    background:#0d0d19;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    height:100vh;
    font-family:sans-serif;
    color:#fff;
    overflow:hidden;
  }
  .machine {
    position:relative;
    width:500px;
    height:500px;
    display:flex;
    justify-content:center;
    align-items:center;
  }
  .reels {
    position:absolute;
    display:flex;
    gap:var(--gap);
    z-index:5;
  }
  .reel-window {
    width:var(--cell-width);
    height:calc(var(--cell-height) * var(--visible-cells));
    overflow:hidden;
    border-radius:12px;
    background:#111;
    box-shadow:0 6px 18px rgba(0,0,0,.6);
  }
  .reel-strip { will-change:transform; }
  .cell {
    width:var(--cell-width);
    height:var(--cell-height);
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
  }
  .cell svg { width:80%; height:80%; }
  .label {
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:600;
    font-size:12px;
    color:#e5e5e5;
    text-align:center;
    padding:4px;
  }
  .overlay {
    position:absolute;
    inset:0;
    z-index:10;
    pointer-events:none;
  }
  .controls { margin-top:20px; }
  button {
    padding:12px 28px;
    border:0;
    border-radius:10px;
    background:linear-gradient(90deg,#7c3aed,#ec4899);
    color:#fff;
    font-size:16px;
    font-weight:700;
    cursor:pointer;
  }
  button[disabled]{opacity:.5;cursor:not-allowed;}
</style>
</head>
<body>
  <div class="machine">
    <div class="reels" id="reels"></div>
    <div class="overlay" id="overlay"></div>
  </div>
  <div class="controls">
    <button id="spin" disabled>–ó–∞–≥—Ä—É–∑–∫–∞...</button>
  </div>

<script>
(async function(){

  /*** üéõ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ***/
  const CONFIG = {
    cellWidth: 100,      // —à–∏—Ä–∏–Ω–∞ –ø–æ–¥–∞—Ä–∫–∞
    aspect: 1.2,         // –≤—ã—Å–æ—Ç–∞ = —à–∏—Ä–∏–Ω–∞ * aspect
    visibleCells: 3,     // —Å–∫–æ–ª—å–∫–æ –≤–∏–¥–Ω–æ –≤ –æ–∫–Ω–µ
    gap: 10,             // —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –±–∞—Ä–∞–±–∞–Ω–∞–º–∏
    offsetX: -40,          // —Å–º–µ—â–µ–Ω–∏–µ –≤—Å–µ–π –≥—Ä—É–ø–ø—ã –ø–æ X
    offsetY: 0           // —Å–º–µ—â–µ–Ω–∏–µ –≤—Å–µ–π –≥—Ä—É–ø–ø—ã –ø–æ Y
  };
  /*********************************************/

  // –ø—Ä–∏–º–µ–Ω—è–µ–º CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  document.documentElement.style.setProperty('--cell-width', CONFIG.cellWidth + 'px');
  document.documentElement.style.setProperty('--aspect', CONFIG.aspect);
  document.documentElement.style.setProperty('--visible-cells', CONFIG.visibleCells);
  document.documentElement.style.setProperty('--gap', CONFIG.gap + 'px');

  const CELL_W = CONFIG.cellWidth;
  const CELL_H = CONFIG.cellWidth * CONFIG.aspect;
  const REELS = 3;

  const gifts = [
    {name:"Desk Calendar", file:"assets/gifts/Desk Calendar.json"},
    {name:"B-Day Candle", file:"assets/gifts/B-Day Candle.json"},
    {name:"Lol Pop", file:"assets/gifts/Lol Pop.json"}
  ];

  const reelsRoot=document.getElementById("reels");
  const overlay=document.getElementById("overlay");
  const spinBtn=document.getElementById("spin");
  let overlayAnim=null;

  reelsRoot.style.transform=`translate(${CONFIG.offsetX}px, ${CONFIG.offsetY}px)`;

  // –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ freeze
  async function preloadFrame(path){
    return new Promise(res=>{
      const tmp=document.createElement("div");
      tmp.style.cssText=`position:fixed;left:-9999px;top:-9999px;width:${CELL_W}px;height:${CELL_H}px`;
      document.body.appendChild(tmp);
      let done=false;
      let anim=lottie.loadAnimation({container:tmp,renderer:"svg",loop:false,autoplay:false,path});
      anim.addEventListener("DOMLoaded",()=>{
        if(done) return;
        done=true;
        anim.goToAndStop(0,true);
        setTimeout(()=>{
          res(tmp.innerHTML);
          anim.destroy();
          tmp.remove();
        },50);
      });
      setTimeout(()=>{
        if(!done){
          done=true;
          try{anim.destroy()}catch{}
          tmp.remove();
          res(null);
        }
      },3000);
    });
  }

  const freezes=[];
  for(let g of gifts){
    try{ freezes.push(await preloadFrame(g.file)); }
    catch{ freezes.push(null); }
  }

  // —Å—Ç—Ä–æ–∏–º –±–∞—Ä–∞–±–∞–Ω—ã
  const reels=[];
  for(let r=0;r<REELS;r++){
    const win=document.createElement("div");
    win.className="reel-window";
    const strip=document.createElement("div");
    strip.className="reel-strip";
    win.appendChild(strip);
    reelsRoot.appendChild(win);
    const cells=[];
    for(let i=0;i<40;i++){
      for(let gi=0;gi<gifts.length;gi++){
        const cell=document.createElement("div");
        cell.className="cell";
        const svgC=document.createElement("div");
        if(freezes[gi]) svgC.innerHTML=freezes[gi];
        const label=document.createElement("div");
        label.className="label";
        label.textContent=gifts[gi].name;
        if(freezes[gi]) label.style.display="none";
        cell.appendChild(svgC);
        cell.appendChild(label);
        strip.appendChild(cell);
        cells.push({el:cell,svg:svgC,gift:gi});
      }
    }
    reels.push({strip,cells,pos:0});
  }

  // overlay –∞–≤—Ç–æ–º–∞—Ç
  try{
    overlayAnim=lottie.loadAnimation({container:overlay,renderer:"svg",loop:false,autoplay:false,path:"assets/777.json"});
  }catch{}

  spinBtn.disabled=false;
  spinBtn.textContent="SPIN";

  let spinning=false;
  spinBtn.onclick=()=>{
    if(spinning) return;
    spinning=true; spinBtn.disabled=true;

    try{overlayAnim.stop();overlayAnim.play()}catch{}

    const results=Array.from({length:REELS},()=>Math.floor(Math.random()*gifts.length));
    const stopDelays=[1000,1500,2000];
    let finished=0;
    const stopped=[];

    for(let r=0;r<REELS;r++){
      spinReel(r,results[r],stopDelays[r],cell=>{
        stopped[r]=cell;
        finished++;
        if(finished===REELS){
          for(let i=0;i<REELS;i++){
            const gi=results[i];
            playOnce(stopped[i].svg,gifts[gi].file,freezes[gi]);
          }
          spinBtn.disabled=false;
          spinning=false;
        }
      });
    }
  };

  function spinReel(idx,targetGift,stopDelay,cb){
    const reel=reels[idx];
    let duration=stopDelay;
    let start=performance.now();
    let from=reel.pos;

    const total=gifts.length;
    const currentIndex=Math.floor(from/CELL_H)%total;
    let delta=(targetGift-currentIndex+total)%total;
    if(delta===0) delta=total;

    const extraTurns=8+Math.floor(Math.random()*9);
    let targetIndex=currentIndex+delta+total*extraTurns;

    // –ø–æ–ø—Ä–∞–≤–∫–∞: —Å—Ç–æ–ø–∞–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã —Ü–µ–ª–µ–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫ –±—ã–ª –ø–æ —Ü–µ–Ω—Ç—Ä—É –æ–∫–Ω–∞ (–≤–∏–¥–Ω–æ 3 ‚Üí —Ü–µ–Ω—Ç—Ä = 2-–π)
    const offsetCenter=(CONFIG.visibleCells>>1)*CELL_H;
    let to=targetIndex*CELL_H - offsetCenter;

    function frame(t){
      let p=Math.min(1,(t-start)/duration);
      let ease=1-Math.pow(1-p,3);
      reel.pos=from+(to-from)*ease;
      reel.strip.style.transform=`translateY(-${reel.pos}px)`;
      if(p<1){ requestAnimationFrame(frame); }
      else {
        reel.pos=to;
        reel.strip.style.transform=`translateY(-${reel.pos}px)`;
        const cell=reel.cells[targetIndex%reel.cells.length];
        cb(cell);
      }
    }
    requestAnimationFrame(frame);
  }

  function playOnce(container,path,freeze){
    if(!container) return;
    setTimeout(()=>{
      container.innerHTML="";
      const anim=lottie.loadAnimation({container,renderer:"svg",loop:false,autoplay:true,path});
      let finished=false;
      anim.addEventListener("complete",()=>{
        if(finished) return;
        finished=true;
        setTimeout(()=>{
          anim.destroy();
          if(freeze) container.innerHTML=freeze;
        },300);
      });
      setTimeout(()=>{
        if(!finished){
          finished=true;
          try{anim.destroy()}catch{}
          if(freeze) container.innerHTML=freeze;
        }
      },6000);
    },400);
  }
})();
</script>
</body>
</html>
