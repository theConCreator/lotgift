<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Slot Machine — Telegram gifts</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Lottie -->
  <script src="https://unpkg.com/lottie-web/build/player/lottie_light.min.js"></script>

  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%; overflow: hidden;
      background: radial-gradient(circle at center, #3b0764, #000);
      font-family: sans-serif;
    }
    .app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      color: #fff;
    }
    .machine-wrap {
      position: relative;
      width: 440px; height: 440px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .reels {
      position: absolute;
      display: flex;
      gap: 12px;
      z-index: 0;
    }
    .slot-window {
      width: 110px; height: 110px;
      overflow: hidden;
      border-radius: 12px;
      background: #fff;
      display: flex; align-items: center; justify-content: center;
      position: relative;
    }
    .slot-strip { will-change: transform; }
    .slot-item {
      width: 110px; height: 110px;
      display: flex; align-items: center; justify-content: center;
      position: relative;
    }
    .machine-lottie {
      position: absolute; inset: 0; z-index: 60; pointer-events: none;
    }
    .spin-btn {
      padding: 10px 26px;
      border-radius: 12px;
      font-weight: 700; font-size: 18px;
      background: linear-gradient(90deg,#7c3aed,#ec4899);
      box-shadow: 0 10px 30px rgba(124,58,237,0.2);
      color: white; cursor: pointer; border: none;
    }
    .spin-btn[disabled] { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/javascript">
const { useState, useEffect, useRef, useMemo } = React;

const ITEM_SIZE = 110;
const REEL_STOP_TIMES = [1000, 1500, 2000]; // ms
const TRANSITION_MS = 500;

const gifts = [
  { name: "Desk Calendar", file: "./assets/gifts/Desk Calendar.json" },
  { name: "B-Day Candle", file: "./assets/gifts/B-Day Candle.json" },
  { name: "Lol Pop", file: "./assets/gifts/Lol Pop.json" }
];

// freeze-кадр из Lottie
async function preloadFreeze(file){
  return new Promise(resolve=>{
    const tmp=document.createElement("div");
    tmp.style.cssText="position:fixed;left:-9999px;width:110px;height:110px";
    document.body.appendChild(tmp);
    const anim=lottie.loadAnimation({
      container:tmp,renderer:"svg",
      loop:false,autoplay:false,path:file
    });
    const check=setInterval(()=>{
      const svg=tmp.querySelector("svg");
      if(svg){
        clearInterval(check);
        try{anim.goToAndStop(0,true);}catch(e){}
        const svgHTML=tmp.innerHTML;
        anim.destroy(); document.body.removeChild(tmp);
        resolve(svgHTML);
      }
    },30);
  });
}

function SlotItem({giftIndex, staticSvgs, animate}){
  const ref=useRef(null);
  useEffect(()=>{
    if(ref.current){
      if(animate){
        ref.current.innerHTML="";
        const anim=lottie.loadAnimation({
          container:ref.current,
          renderer:"svg",loop:false,autoplay:true,
          path:gifts[giftIndex].file
        });
        anim.addEventListener("complete",()=>{
          anim.destroy();
          ref.current.innerHTML=staticSvgs[giftIndex];
        });
      } else {
        ref.current.innerHTML=staticSvgs[giftIndex]||"";
      }
    }
  },[giftIndex,animate,staticSvgs]);
  return React.createElement("div",{className:"slot-item"},
    React.createElement("div",{ref})
  );
}

function Reel({ reelIndex, spinning, finalGift, staticSvgs, stopDelay, onStop }){
  const stripRef=useRef(null);
  const [pos,setPos]=useState(0);
  const [animTrigger,setAnimTrigger]=useState(false);

  // дублируем список подарков ×4
  const stripItems=useMemo(()=>{
    let arr=[];
    for(let i=0;i<4;i++) arr=arr.concat([0,1,2]);
    return arr;
  },[]);

  const totalHeight=stripItems.length*ITEM_SIZE;

  useEffect(()=>{
    if(spinning){
      setAnimTrigger(false);
      let p=0;
      const interval=setInterval(()=>{
        p=(p+25)%totalHeight;
        setPos(p);
      },30);

      const stopTimer=setTimeout(()=>{
        clearInterval(interval);
        // рассчитаем позицию для остановки на finalGift
        const idx=stripItems.lastIndexOf(finalGift);
        const offset=idx*ITEM_SIZE;
        stripRef.current.style.transition=`transform ${TRANSITION_MS}ms ease-out`;
        stripRef.current.style.transform=`translateY(-${offset}px)`;
        stripRef.current.addEventListener("transitionend",()=>{
          setAnimTrigger(true);
          onStop();
        },{once:true});
      },stopDelay);

      return ()=>{clearInterval(interval);clearTimeout(stopTimer);}
    }
  },[spinning,finalGift]);

  return React.createElement("div",{className:"slot-window"},
    React.createElement("div",{
      ref:stripRef,className:"slot-strip",
      style:{transform:`translateY(-${pos}px)`}
    },
      stripItems.map((idx,i)=>
        React.createElement(SlotItem,{
          key:i,giftIndex:idx,staticSvgs,
          animate:(i===stripItems.lastIndexOf(finalGift) && animTrigger)
        })
      )
    )
  );
}

function App(){
  const [loading,setLoading]=useState(true);
  const [staticSvgs,setStaticSvgs]=useState({});
  const [spinning,setSpinning]=useState(false);
  const [finals,setFinals]=useState([0,1,2]);
  const machineRef=useRef(null);
  const machineAnim=useRef(null);
  const stopped=useRef(0);

  useEffect(()=>{
    (async()=>{
      const map={};
      for(let i=0;i<gifts.length;i++){
        map[i]=await preloadFreeze(gifts[i].file);
      }
      setStaticSvgs(map);
      setLoading(false);
    })();
  },[]);

  useEffect(()=>{
    if(machineRef.current){
      machineAnim.current=lottie.loadAnimation({
        container:machineRef.current,renderer:"svg",
        loop:false,autoplay:false,path:"./assets/777.json"
      });
    }
  },[]);

  function spin(){
    if(spinning||loading) return;
    setFinals([0,1,2].map(()=>Math.floor(Math.random()*gifts.length)));
    setSpinning(true);
    stopped.current=0;
    if(machineAnim.current){
      machineAnim.current.goToAndStop(0,true);
      machineAnim.current.play();
    }
  }

  function onStop(){
    stopped.current++;
    if(stopped.current===3){
      setSpinning(false);
      if(finals[0]===finals[1]&&finals[1]===finals[2]){
        alert("🎉 Вы выиграли: "+gifts[finals[0]].name);
      }
    }
  }

  return React.createElement("div",{className:"app"},
    React.createElement("div",{className:"machine-wrap"},
      React.createElement("div",{className:"reels"},
        [0,1,2].map(i=>
          React.createElement(Reel,{
            key:i,reelIndex:i,spinning,
            finalGift:finals[i],staticSvgs,
            stopDelay:REEL_STOP_TIMES[i],onStop
          })
        )
      ),
      React.createElement("div",{className:"machine-lottie",ref:machineRef})
    ),
    React.createElement("button",{className:"spin-btn",onClick:spin,disabled:spinning||loading},
      spinning?"Крутим...":"Spin 🎰"
    )
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
</script>
</body>
</html>
