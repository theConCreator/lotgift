<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Slot Machine â€” Gifts Fixed</title>

<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/lottie-web/build/player/lottie_light.min.js"></script>

<style>
  :root { --item-size: 110px; }
  html,body {
    margin:0; height:100%;
    background: radial-gradient(circle at center,#0b0b12,#0f0730);
    font-family: Inter, system-ui, sans-serif;
  }
  .app {
    height:100%; display:flex; flex-direction:column;
    align-items:center; justify-content:center; gap:20px;
  }
  .machine {
    display:flex; gap:18px; position:relative; z-index:100;
  }
  .slot-window {
    width:var(--item-size); height:var(--item-size);
    overflow:hidden; border-radius:14px;
    background: linear-gradient(180deg,#0b0b0f,#111);
    box-shadow:0 10px 30px rgba(0,0,0,0.6);
    display:flex; align-items:center; justify-content:center;
  }
  .slot-strip { will-change: transform; }
  .slot-cell {
    width:var(--item-size); height:var(--item-size);
    display:flex; align-items:center; justify-content:center;
    position:relative;
  }
  .cell-lottie {
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
  }
  .cell-label {
    z-index:10; font-weight:700; font-size:13px; text-align:center; color:#eee;
  }
  .controls { display:flex; gap:12px; }
  .spin-btn {
    padding:12px 26px; border-radius:12px; border:0;
    background: linear-gradient(90deg,#7c3aed,#ec4899);
    color:#fff; font-weight:700; font-size:16px;
    cursor:pointer;
  }
  .spin-btn[disabled]{ opacity:0.5; cursor:not-allowed; }
</style>
</head>
<body>
<div id="root"></div>

<script>
(function(){
  const {useState,useEffect,useRef} = React;

  const ITEM_SIZE=110;
  const GIFTS=[
    { name:"Desk Calendar", file:"assets/gifts/Desk Calendar.json" },
    { name:"B-Day Candle", file:"assets/gifts/B-Day Candle.json" },
    { name:"Lol Pop", file:"assets/gifts/Lol Pop.json" }
  ];

  // Lottie loader (safe)
  async function safeLoad(container,path){
    try{
      const res=await fetch(path); if(!res.ok) return null;
      return lottie.loadAnimation({container,renderer:"svg",loop:false,autoplay:false,path});
    }catch(e){ return null; }
  }

  function SlotCell({gift,api}){
    const ref=useRef(null); const anim=useRef(null);
    useEffect(()=>{
      api.init=async()=>{
        if(!ref.current) return;
        anim.current=await safeLoad(ref.current,gift.file);
        if(anim.current) anim.current.goToAndStop(0,true);
      };
      api.play=()=>{
        if(anim.current){
          anim.current.goToAndStop(0,true);
          anim.current.play();
        }
      };
    },[]);
    return React.createElement("div",{className:"slot-cell"},
      React.createElement("div",{className:"cell-lottie",ref:ref}),
      React.createElement("div",{className:"cell-label"},gift.name)
    );
  }

  function Reel({targetIndex,spinning,onStop,delay}){
    const CYCLES=7; // Ð½ÐµÑ‡Ñ‘Ñ‚Ð½Ð¾Ðµ â†’ Ñ†ÐµÐ½Ñ‚Ñ€ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹
    const arr=[]; for(let c=0;c<CYCLES;c++){for(let g of GIFTS) arr.push(g);}
    const totalH=arr.length*ITEM_SIZE;

    const strip=useRef(null);
    const pos=useRef(0); let raf;

    const cellApis=useRef(arr.map(()=>({})));

    // init lotties once
    useEffect(()=>{ cellApis.current.forEach(api=>api.init&&api.init()); },[]);

    useEffect(()=>{
      if(!spinning){
        cancelAnimationFrame(raf);
        return;
      }
      let start; function step(ts){
        if(!start) start=ts;
        const dt=ts-start;
        pos.current+=dt*0.3; start=ts;
        const rel=((pos.current%totalH)+totalH)%totalH;
        strip.current.style.transform=`translateY(-${rel}px)`;
        raf=requestAnimationFrame(step);
      }
      raf=requestAnimationFrame(step);

      const timer=setTimeout(async()=>{
        cancelAnimationFrame(raf);
        // snap to target
        const currentIndex=Math.round(pos.current/ITEM_SIZE)%GIFTS.length;
        let delta=(targetIndex-currentIndex+GIFTS.length)%GIFTS.length;
        if(delta===0) delta=GIFTS.length;
        pos.current+=delta*ITEM_SIZE;
        const rel=((pos.current%totalH)+totalH)%totalH;
        strip.current.style.transform=`translateY(-${rel}px)`;
        // trigger anim on visible cell
        const cells=document.elementsFromPoint(
          strip.current.getBoundingClientRect().x+ITEM_SIZE/2,
          strip.current.parentElement.getBoundingClientRect().y+ITEM_SIZE/2
        );
        const idx=arr.findIndex(g=>g===GIFTS[targetIndex]);
        if(cellApis.current[idx]) cellApis.current[idx].play();
        onStop();
      },delay);

      return ()=>{clearTimeout(timer); cancelAnimationFrame(raf);};
    },[spinning,targetIndex]);

    return React.createElement("div",{className:"slot-window"},
      React.createElement("div",{className:"slot-strip",ref:strip},
        arr.map((g,i)=>React.createElement(SlotCell,{key:i,gift:g,api:cellApis.current[i]}))
      )
    );
  }

  function App(){
    const [spin,setSpin]=useState(false);
    const [targets,setTargets]=useState([0,0,0]);
    const stopped=useRef(0);

    function start(){
      if(spin) return;
      const t=[0,1,2].map(()=>Math.floor(Math.random()*GIFTS.length));
      setTargets(t); stopped.current=0; setSpin(true);
    }
    function onStop(){
      stopped.current++;
      if(stopped.current===3){setSpin(false);}
    }

    return React.createElement("div",{className:"app"},
      React.createElement("div",{className:"machine"},
        React.createElement(Reel,{targetIndex:targets[0],spinning:spin,onStop,delay:1000}),
        React.createElement(Reel,{targetIndex:targets[1],spinning:spin,onStop,delay:1500}),
        React.createElement(Reel,{targetIndex:targets[2],spinning:spin,onStop,delay:2000}),
      ),
      React.createElement("div",{className:"controls"},
        React.createElement("button",{className:"spin-btn",onClick:start,disabled:spin},spin?"...":"Spin ðŸŽ°")
      )
    );
  }

  ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
})();
</script>
</body>
</html>
