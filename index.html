<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Slot Machine 🎰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/lottie-web/build/player/lottie_light.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: radial-gradient(circle at center, #3b0764, #000);
    }
    .slot-window {
      width: 100px;
      height: 100px;
      overflow: hidden;
      border-radius: 12px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 12px rgba(255,255,255,0.3);
    }
    .slot-strip {
      will-change: transform;
    }
  </style>
</head>
<body class="flex items-center justify-center h-screen w-screen text-white">
  <div id="root"></div>

  <script type="text/javascript">
    const { useState, useEffect, useRef } = React;

    // 🎁 Подарки (3 тестовых)
    const gifts = [
      { name: "Desk Calendar", file: "./assets/gifts/Desk Calendar.json" },
      { name: "B-Day Candle", file: "./assets/gifts/B-Day Candle.json" },
      { name: "Lol Pop", file: "./assets/gifts/Lol Pop.json" }
    ];

    // 🔹 Компонент подарка
    function GiftItem({ gift, animate }) {
      const ref = useRef(null);
      useEffect(() => {
        if (!gift || !ref.current) return;
        ref.current.innerHTML = "";
        const anim = lottie.loadAnimation({
          container: ref.current,
          renderer: "svg",
          loop: false,
          autoplay: false,
          path: gift.file
        });
        if (animate) {
          anim.play();
        } else {
          anim.goToAndStop(0, true); // ❄️ freeze frame
        }
        return () => anim.destroy();
      }, [gift, animate]);
      return React.createElement("div", { ref, className: "w-[100px] h-[100px] flex items-center justify-center" });
    }

    // 🔹 Один барабан
    function Reel({ spinning, finalGift, stopAfter }) {
      const [offset, setOffset] = useState(0);
      const stripRef = useRef(null);

      // формируем длинную ленту
      const items = [];
      for (let i = 0; i < 8; i++) {
        items.push(...gifts);
      }
      items.push(finalGift);

      useEffect(() => {
        if (!spinning || !finalGift) return;
        const finalIndex = items.length - 1;
        const targetOffset = -(finalIndex * 100);

        stripRef.current.style.transition = "none";
        setOffset(0);

        const t = setTimeout(() => {
          stripRef.current.style.transition = "transform 0.5s cubic-bezier(0.25, 1, 0.5, 1)";
          setOffset(targetOffset);
        }, stopAfter);

        return () => clearTimeout(t);
      }, [spinning, finalGift]);

      return (
        React.createElement("div", { className: "slot-window" },
          React.createElement("div", {
            ref: stripRef,
            className: "slot-strip",
            style: { transform: `translateY(${offset}px)` }
          },
            items.map((gift, i) =>
              React.createElement(GiftItem, {
                key: i,
                gift,
                animate: (!spinning && finalGift && i === items.length - 1)
              })
            )
          )
        )
      );
    }

    // 🎰 Автомат
    function SlotMachine() {
      const [spinning, setSpinning] = useState(false);
      const [final, setFinal] = useState([null, null, null]);
      const machineRef = useRef(null);
      const machineAnim = useRef(null);

      // Загружаем анимацию автомата
      useEffect(() => {
        if (!machineRef.current) return;
        machineAnim.current = lottie.loadAnimation({
          container: machineRef.current,
          renderer: "svg",
          loop: false,
          autoplay: false,
          path: "./assets/777.json"
        });
      }, []);

      const spin = () => {
        if (spinning) return;

        // финальные результаты
        const results = [
          gifts[Math.floor(Math.random() * gifts.length)],
          gifts[Math.floor(Math.random() * gifts.length)],
          gifts[Math.floor(Math.random() * gifts.length)]
        ];
        setFinal(results);
        setSpinning(true);

        // проигрываем автомат
        if (machineAnim.current) {
          machineAnim.current.goToAndStop(0, true);
          machineAnim.current.play();
        }

        setTimeout(() => setSpinning(false), 2500);
      };

      return (
        React.createElement("div", { className: "flex flex-col items-center" },
          React.createElement("div", { className: "relative w-[400px] h-[400px] flex items-center justify-center" },
            // барабаны
            React.createElement("div", { className: "absolute flex gap-4 z-0" },
              final.map((gift, i) =>
                React.createElement(Reel, { 
                  key: i, 
                  spinning, 
                  finalGift: gift, 
                  stopAfter: i === 0 ? 1000 : i === 1 ? 1500 : 2000
                })
              )
            ),
            // автомат поверх
            React.createElement("div", { ref: machineRef, className: "absolute inset-0 z-50" })
          ),
          React.createElement("button", {
            onClick: spin,
            disabled: spinning,
            className: "mt-6 px-8 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold text-lg rounded-xl shadow-lg hover:scale-105 transition disabled:opacity-50"
          }, spinning ? "Крутим..." : "Spin 🎰")
        )
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(SlotMachine));
  </script>
</body>
</html>
