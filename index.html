<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Slot Machine Fixed</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #111;
      color: white;
      font-family: sans-serif;
    }
    .machine {
      display: flex;
      gap: 10px;
      padding: 20px;
      border: 4px solid #444;
      border-radius: 16px;
      background: #222;
    }
    .reel {
      width: 120px;
      height: 120px;
      overflow: hidden;
      border: 2px solid #555;
      background: black;
    }
    .strip {
      display: flex;
      flex-direction: column;
      will-change: transform;
    }
    .item {
      width: 120px;
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      background: #000;
      color: white;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #28a745;
      color: white;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const gifts = [
      {name:"Desk Calendar"}, 
      {name:"B-Day Candle"}, 
      {name:"Lol Pop"}
    ];

    const ITEM_SIZE = 120;
    const REPEAT_COUNT = 50; // лента в 50 циклов

    function Reel({ finalIndex, stopDelay, spinning }) {
      const stripRef = React.useRef(null);
      const posRef = React.useRef(0);
      const rafRef = React.useRef(null);
      const runningRef = React.useRef(false);
      const items = [];

      for (let i = 0; i < REPEAT_COUNT; i++) {
        for (let g of gifts) {
          items.push(<div className="item" key={i+"-"+g.name}>{g.name}</div>);
        }
      }
      const totalHeight = gifts.length * ITEM_SIZE * REPEAT_COUNT;

      React.useEffect(() => {
        if (spinning) {
          runningRef.current = true;
          function step() {
            if (!runningRef.current) return;
            posRef.current += 20; // скорость
            const mod = posRef.current % totalHeight;
            stripRef.current.style.transform = `translateY(-${mod}px)`;
            rafRef.current = requestAnimationFrame(step);
          }
          rafRef.current = requestAnimationFrame(step);

          const stopTimer = setTimeout(() => {
            runningRef.current = false;
            if (rafRef.current) cancelAnimationFrame(rafRef.current);

            const currentIndex = Math.floor(posRef.current / ITEM_SIZE);
            const loops = 3;
            const targetIndex = currentIndex + loops * gifts.length + finalIndex;
            const offset = targetIndex * ITEM_SIZE;

            stripRef.current.style.transition = "transform 0.8s ease-out";
            stripRef.current.style.transform = `translateY(-${offset}px)`;

            stripRef.current.addEventListener("transitionend", () => {
              stripRef.current.style.transition = "";
              const reset = finalIndex * ITEM_SIZE;
              stripRef.current.style.transform = `translateY(-${reset}px)`;
              posRef.current = reset;
            }, {once:true});
          }, stopDelay);

          return () => clearTimeout(stopTimer);
        }
      }, [spinning]);

      return (
        <div className="reel">
          <div className="strip" ref={stripRef}>
            {items}
          </div>
        </div>
      );
    }

    function App() {
      const [spinning, setSpinning] = React.useState(false);
      const [results, setResults] = React.useState([0,0,0]);

      const spin = () => {
        if (spinning) return;
        const newResults = [
          Math.floor(Math.random() * gifts.length),
          Math.floor(Math.random() * gifts.length),
          Math.floor(Math.random() * gifts.length),
        ];
        setResults(newResults);
        setSpinning(true);
        setTimeout(() => setSpinning(false), 3000);
      };

      return (
        <div>
          <div className="machine">
            <Reel finalIndex={results[0]} stopDelay={1000} spinning={spinning}/>
            <Reel finalIndex={results[1]} stopDelay={1500} spinning={spinning}/>
            <Reel finalIndex={results[2]} stopDelay={2000} spinning={spinning}/>
          </div>
          <button onClick={spin}>SPIN</button>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
