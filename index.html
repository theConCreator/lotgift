<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Slot Machine ‚Äî Telegram gifts</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React / ReactDOM (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- lottie -->
  <script src="https://unpkg.com/lottie-web/build/player/lottie_light.min.js"></script>

  <style>
    :root {
      --item-size: 110px; /* —Ä–∞–∑–º–µ—Ä –∫–∞–∂–¥–æ–≥–æ —Å–ª–æ—Ç–∞ (–º–µ–Ω—è–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ) */
      --reel-count: 3;
    }
    html,body {
      height:100%;
      margin:0;
      padding:0;
      overflow:hidden; /* –∑–∞–ø—Ä–µ—Ç —Å–∫—Ä–æ–ª–ª–∞ */
      background: radial-gradient(circle at center, #3b0764, #000);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    /* –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ */
    .app {
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:28px;
      flex-direction:column;
      color:#fff;
    }

    /* –ú–∞—à–∏–Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    .machine-wrap {
      position:relative;
      width:440px;
      height:440px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* –ë–∞—Ä–∞–±–∞–Ω—ã ‚Äî –≤ —Ä—è–¥, –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–æ–º */
    .reels {
      position:absolute;
      display:flex;
      gap:14px;
      z-index:0; /* –ø–æ–∑–∞–¥–∏ –∞–≤—Ç–æ–º–∞—Ç–∞ */
      align-items:center;
      justify-content:center;
    }

    /* –û–∫–æ—à–∫–æ –∫–∞–∂–¥–æ–≥–æ –±–∞—Ä–∞–±–∞–Ω–∞ */
    .slot-window {
      width: var(--item-size);
      height: var(--item-size);
      overflow:hidden;
      border-radius:14px;
      background: #fff;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.45);
    }

    /* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–µ–Ω—Ç–∞ */
    .slot-strip {
      will-change: transform;
      display:block;
    }

    .slot-item {
      width: var(--item-size);
      height: var(--item-size);
      display:flex;
      align-items:center;
      justify-content:center;
      background: transparent;
    }

    /* –ê–≤—Ç–æ–º–∞—Ç –ø–æ–≤–µ—Ä—Ö –±–∞—Ä–∞–±–∞–Ω–æ–≤ */
    .machine-lottie {
      position:absolute;
      inset:0;
      z-index:60; /* –ø–æ–≤–µ—Ä—Ö –±–∞—Ä–∞–±–∞–Ω–æ–≤ */
      pointer-events:none; /* —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã */
    }

    /* –ö–Ω–æ–ø–∫–∞ */
    .spin-btn {
      appearance:none;
      border:0;
      cursor:pointer;
      padding:10px 26px;
      border-radius:12px;
      font-weight:700;
      font-size:18px;
      background:linear-gradient(90deg,#7c3aed,#ec4899);
      box-shadow: 0 10px 30px rgba(124,58,237,0.2);
      color:white;
    }
    .spin-btn[disabled] { opacity:0.5; cursor:not-allowed; transform:none; }

    /* Loading overlay */
    .loading {
      position: absolute;
      inset:0;
      z-index:70;
      display:flex;
      align-items:center;
      justify-content:center;
      backdrop-filter: blur(6px);
    }

    /* Result toast */
    .toast {
      margin-top:12px;
      padding:10px 16px;
      background: rgba(255,255,255,0.06);
      border-radius:10px;
      font-weight:600;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/javascript">
  (function () {
    const { useState, useEffect, useRef } = React;

    /* ========== –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ========== */
    const ITEM_SIZE = 110; // px, –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å CSS var --item-size
    const REPEAT_CYCLES = 8; // —Å–∫–æ–ª—å–∫–æ —Ü–∏–∫–ª–æ–≤ –ø–æ–¥–∞—Ä–∫–æ–≤ –≤ –ª–µ–Ω—Ç–µ –ø–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª—å–Ω—ã–º —ç–ª–µ–º–µ–Ω—Ç–æ–º
    const TRANSITION_MS = 400; // –≤—Ä–µ–º—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–æ—Ä–º–æ–∂–µ–Ω–∏—è –≤ ms (–±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –≤ —Ä–∞—Å—á—ë—Ç–∞—Ö)
    // –í—Ä–µ–º—è, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –¥–æ–ª–∂–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –∫–∞–∂–¥—ã–π –±–∞—Ä–∞–±–∞–Ω (–≤ ms –æ—Ç —Å—Ç–∞—Ä—Ç–∞)
    const REEL_STOP_TIMES = [1000, 1500, 2000];

    // –¢–≤–æ–∏ 3 –ø–æ–¥–∞—Ä–∫–∞ (json Lottie). –ü—É—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ index.html
    const gifts = [
      { name: "Desk Calendar", file: "./assets/gifts/Desk Calendar.json" },
      { name: "B-Day Candle", file: "./assets/gifts/B-Day Candle.json" },
      { name: "Lol Pop", file: "./assets/gifts/Lol Pop.json" }
    ];

    /* ========== –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ freeze-frame SVG ========== */

    // –ó–∞–≥—Ä—É–∂–∞–µ—Ç Lottie –≤ –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–∞ –∫–∞–¥—Ä–µ 0 –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç innerHTML (SVG)
    function preloadLottieFreeze(file) {
      return new Promise((resolve) => {
        const tmp = document.createElement('div');
        tmp.style.position = 'fixed';
        tmp.style.left = '-9999px';
        tmp.style.width = ITEM_SIZE + 'px';
        tmp.style.height = ITEM_SIZE + 'px';
        document.body.appendChild(tmp);

        const anim = lottie.loadAnimation({
          container: tmp,
          renderer: "svg",
          loop: false,
          autoplay: false,
          path: file
        });

        // wait until a <svg> appears or timeout
        let attempts = 0;
        const check = setInterval(() => {
          const svg = tmp.querySelector('svg');
          attempts++;
          if (svg) {
            clearInterval(check);
            try { anim.goToAndStop(0, true); } catch(e){ /*ignore*/ }
            // small delay to ensure svg updated
            setTimeout(() => {
              const svgHTML = tmp.innerHTML;
              anim.destroy();
              document.body.removeChild(tmp);
              resolve(svgHTML);
            }, 50);
          } else if (attempts > 80) { // fallback
            clearInterval(check);
            try { anim.goToAndStop(0, true); } catch(e){}
            setTimeout(() => {
              const svgHTML = tmp.innerHTML;
              anim.destroy();
              document.body.removeChild(tmp);
              resolve(svgHTML);
            }, 80);
          }
        }, 20);
      });
    }

    /* ========== GiftItem: —Ä–µ–Ω–¥–µ—Ä–∏—Ç –ª–∏–±–æ —Å—Ç–∞—Ç–∏—á–Ω—ã–π SVG (freeze), –ª–∏–±–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç Lottie ========== */
    function GiftItem({ giftIndex, staticSvgs, animateFlag, onCreateAnim }) {
      const holderRef = useRef(null);

      useEffect(() => {
        const el = holderRef.current;
        if (!el) return;
        el.innerHTML = ""; // –æ—á–∏—Å—Ç–∫–∞

        if (!staticSvgs[giftIndex]) {
          // safety - –µ—Å–ª–∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ svg –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤—ã, –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç
          el.textContent = "loading";
          return;
        }

        if (animateFlag) {
          // —Å–æ–∑–¥–∞—ë–º –Ω–∞—Å—Ç–æ—è—â–∏–π lottie –ø–ª–µ–µ—Ä –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏ —Å—Ä–∞–∑—É play()
          const anim = lottie.loadAnimation({
            container: el,
            renderer: "svg",
            loop: false,
            autoplay: true,
            path: gifts[giftIndex].file
          });
          if (typeof onCreateAnim === 'function') onCreateAnim(anim);
          return () => { try { anim.destroy(); } catch(e){} };
        } else {
          // –≤—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–µ svg (freeze frame) ‚Äî –∫–ª–æ–Ω–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–æ–π
          el.innerHTML = staticSvgs[giftIndex] || "";
          return;
        }
      }, [giftIndex, staticSvgs, animateFlag]);

      return React.createElement('div', {
        ref: holderRef,
        className: 'slot-item'
      });
    }

    /* ========== Reel: –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —Å–≤–æ—é –ª–µ–Ω—Ç—É ========== */
    function Reel({ reelIndex, spinning, finalGiftIndex, staticSvgs, stopStartDelay, onReelStopped }) {
      const stripRef = useRef(null);
      const rafRef = useRef(null);
      const lastTsRef = useRef(null);
      const posRef = useRef(0); // —Ç–µ–∫—É—â–µ–µ "—Å–º–µ—â–µ–Ω–∏–µ" –≤ px
      const activeRef = useRef(false); // true -> rAF –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–∑–∏—Ü–∏—é
      const stoppedRef = useRef(false);
      const animInstanceRef = useRef(null);

      // –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è –ª–µ–Ω—Ç–∞ –∏–Ω–¥–µ–∫—Å–æ–≤ (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ –º–µ–∂–¥—É —Å–ø–∏–Ω–∞–º–∏)
      const baseArrayRef = useRef(null);
      if (!baseArrayRef.current) {
        const base = [];
        // –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º REPEAT_CYCLES * gifts.length —Å–ª—É—á–∞–π–Ω–æ –ø–µ—Ä–µ–º–µ—à–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã,
        // —á—Ç–æ–±—ã –ª–µ–Ω—Ç–∞ –Ω–µ –±—ã–ª–∞ —Å–∫—É—á–Ω—ã–º –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ–º
        for (let c=0; c<REPEAT_CYCLES; c++) {
          // shuffle one cycle
          const seq = [...Array(gifts.length).keys()];
          for (let i = seq.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [seq[i], seq[j]] = [seq[j], seq[i]];
          }
          base.push(...seq);
        }
        baseArrayRef.current = base;
      }

      // items –±—É–¥–µ—Ç –∏—Å—Ö–æ–¥–Ω–æ–π –ª–µ–Ω—Ç–æ–π + —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –∏–Ω–¥–µ–∫—Å (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–ø–∏–Ω–∞)
      const [items, setItems] = useState([...baseArrayRef.current]);

      // –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ finalGiftIndex (–Ω–∞—á–∞–ª–æ —Å–ø–∏–Ω–∞) ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç
      useEffect(() => {
        if (finalGiftIndex == null) return;
        // —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –ª–µ–Ω—Ç—É: –∫–æ–ø–∏—è base + final
        setItems(prev => {
          // always recreate from base to avoid –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ –¥–ª–∏–Ω–Ω—ã–µ –ª–µ–Ω—Ç—ã
          return [...baseArrayRef.current, finalGiftIndex];
        });
        // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é (–±–µ–∑ transition)
        posRef.current = 0;
        if (stripRef.current) {
          stripRef.current.style.transition = 'none';
          stripRef.current.style.transform = `translateY(0px)`;
        }
        stoppedRef.current = false;
      }, [finalGiftIndex]);

      // –ì–ª–∞–≤–Ω—ã–π rAF-—Å–ø–∏–Ω: –æ–±–Ω–æ–≤–ª—è–µ–º translateY –ø–æ–∫–∞ activeRef==true
      useEffect(() => {
        let mounted = true;
        function step(ts) {
          if (!mounted) return;
          if (lastTsRef.current == null) lastTsRef.current = ts;
          const dt = ts - lastTsRef.current;
          lastTsRef.current = ts;

          if (activeRef.current && !stoppedRef.current) {
            // —Å–∫–æ—Ä–æ—Å—Ç—å –≤ px/ms ‚Äî –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–¥ –Ω—É–∂–Ω—É—é –≤–∏–∑—É–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å
            const speedPxPerMs = 0.5; // 0.5 px per ms => 500 px/s
            posRef.current = (posRef.current + speedPxPerMs * dt) % (items.length * ITEM_SIZE);
            stripRef.current.style.transition = 'none';
            stripRef.current.style.transform = `translateY(-${posRef.current}px)`;
          }
          rafRef.current = requestAnimationFrame(step);
        }

        rafRef.current = requestAnimationFrame(step);
        return () => { mounted = false; cancelAnimationFrame(rafRef.current); lastTsRef.current = null; };
      }, [items.length]); // –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –ª–µ–Ω—Ç—ã

      // –ó–∞–ø—É—Å–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø—Ä–∏ spinning === true
      useEffect(() => {
        if (spinning) {
          // –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º rAF-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          activeRef.current = true;
          stoppedRef.current = false;
          // –æ—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
          if (animInstanceRef.current) { try { animInstanceRef.current.destroy(); } catch(e){ } animInstanceRef.current = null; }

          // –∑–∞–ø–ª–∞–Ω–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ —Ç–æ—Ä–º–æ–∂–µ–Ω–∏—è ‚Äî –Ω—É–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Ç–æ—Ä–º–æ–∑–∏—Ç—å –≤ –º–æ–º–µ–Ω—Ç stopStartDelay,
          // —Ç–∞–∫ —á—Ç–æ–±—ã —Ñ–∏–Ω–∞–ª—å–Ω—ã–π CSS –ø–µ—Ä–µ—Ö–æ–¥ –¥–ª–∏–Ω–æ–π TRANSITION_MS –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –≤ REEL_STOP_TIMES[reelIndex].
          // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã: stopStartDelay —É–∂–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –∫–∞–∫ (stopFinish - TRANSITION_MS)
          const tId = setTimeout(() => {
            // –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π rAF –∞–ø–¥–µ–π—Ç –¥–ª—è —ç—Ç–æ–π –∫–∞—Ç—É—à–∫–∏
            activeRef.current = false;

            // –≤—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –ø–æ–∑–∏—Ü–∏—é –∏ —Ü–µ–ª–µ–≤—É—é –ø–æ–∑–∏—Ü–∏—é –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            const totalHeight = items.length * ITEM_SIZE;
            const currentPos = (posRef.current % totalHeight + totalHeight) % totalHeight;
            const finalIndex = items.length - 1;
            const finalPosNormalized = finalIndex * ITEM_SIZE;

            // delta –≤–ø–µ—Ä–µ–¥ (–≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è)
            let delta = (finalPosNormalized - currentPos + totalHeight) % totalHeight;
            // –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–µ —Å–º–µ—â–µ–Ω–∏–µ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω —Ü–∏–∫–ª —á—Ç–æ–±—ã —ç—Ñ—Ñ–µ–∫—Ç –±—ã–ª –∑–∞–º–µ—Ç–µ–Ω
            if (delta < 40) delta += totalHeight;

            // –î–æ–±–∞–≤–∏–º –æ–¥–Ω—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –æ–±–æ—Ä–æ—Ç–∫—É –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–∏–∑—É–∞–ª–∞
            const targetPos = currentPos + delta + totalHeight;

            // –ø—Ä–∏–º–µ–Ω—è–µ–º transition –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω–µ—á–Ω—ã–π transform
            if (stripRef.current) {
              stripRef.current.style.transition = `transform ${TRANSITION_MS}ms cubic-bezier(0.25,1,0.5,1)`;
              stripRef.current.style.transform = `translateY(-${targetPos}px)`;

              // –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ transition ‚Äî –ø–æ–º–µ—Ç–∏–º –∫–∞–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∏ –∑–∞–ø—É—Å—Ç–∏–º –∞–Ω–∏–º–∞—Ü–∏—é —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥–∞—Ä–∫–∞
              const onTransEnd = (ev) => {
                if (ev && ev.propertyName !== 'transform') return;
                stripRef.current.removeEventListener('transitionend', onTransEnd);
                stoppedRef.current = true;
                // –æ–±–Ω–æ–≤–∏–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–º–µ—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å–ø–∏–Ω–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å
                posRef.current = targetPos % totalHeight;

                // –∑–∞–ø—É—Å—Ç–∏—Ç—å Lottie-–∞–Ω–∏–º–∞—Ü–∏—é –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–º —ç–ª–µ–º–µ–Ω—Ç–µ:
                // last element (–≤ DOM) ‚Äî —ç—Ç–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ (–ø–æ—Ç–æ–º—É —á—Ç–æ items —Å–æ–¥–µ—Ä–∂–∏—Ç finalIndex –≤ –∫–æ–Ω—Ü–µ)
                const lastChild = stripRef.current.lastElementChild;
                if (lastChild) {
                  lastChild.innerHTML = ''; // –æ—á–∏—Å—Ç–∏–º static svg
                  // —Å–æ–∑–¥–∞—ë–º —Ä–µ–∞–ª—å–Ω—É—é Lottie –∞–Ω–∏–º–∞—Ü–∏—é –∏ play()
                  const anim = lottie.loadAnimation({
                    container: lastChild,
                    renderer: "svg",
                    loop: false,
                    autoplay: true,
                    path: gifts[ finalGiftIndex ].file
                  });
                  anim.addEventListener('complete', () => {
                    // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ (–∞–Ω–∏–º–∞—Ü–∏—è –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å)
                    try { anim.stop(); } catch(e) {}
                    // –º–æ–∂–Ω–æ –Ω–µ —É–Ω–∏—á—Ç–æ–∂–∞—Ç—å ‚Äî –Ω–æ –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã —É–Ω–∏—á—Ç–æ–∂–∏–º
                    try { anim.destroy(); } catch(e) {}
                  });
                }

                if (typeof onReelStopped === 'function') onReelStopped(reelIndex);
              };

              stripRef.current.addEventListener('transitionend', onTransEnd);
            }
          }, stopStartDelay);

          return () => clearTimeout(tId);
        } else {
          // –µ—Å–ª–∏ —Å–ø–∏–Ω false (–µ—â–µ –¥–æ –Ω–æ–≤–æ–≥–æ —Å–ø–∏–Ω–∞) ‚Äî –ø–µ—Ä–µ—Å—Ç—Ä–∞—Ö—É–µ–º—Å—è
          activeRef.current = false;
        }
      }, [spinning, items, finalGiftIndex]);

      // –ü—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ ‚Äî –ø–æ—á–∏—Å—Ç–∏–º
      useEffect(() => {
        return () => {
          activeRef.current = false;
          if (animInstanceRef.current) {
            try { animInstanceRef.current.destroy(); } catch(e) {}
            animInstanceRef.current = null;
          }
        };
      }, []);

      // –†–µ–Ω–¥–µ—Ä–∏–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã (–∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –≤ –∫–æ—Ç–æ—Ä—ã–π –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã staticSvgs –∏–ª–∏ –∞–Ω–∏–º–∞—Ü–∏—è)
      return React.createElement('div', { className: 'slot-window' },
        React.createElement('div', {
          ref: stripRef,
          className: 'slot-strip',
          style: { transform: 'translateY(0px)' }
        },
          items.map((idx, i) => {
            return React.createElement('div', {
              key: i,
              className: 'slot-item',
              // –∞—Ç—Ä–∏–±—É—Ç data-gift-index —á—Ç–æ–±—ã –ª–µ–≥—á–µ –¥–µ–±–∞–∂–∏—Ç—å
              'data-gift-index': idx
            }, /* –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è SVG/animation –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω —á–µ—Ä–µ–∑ GiftItem-like –ø–æ–¥—Ö–æ–¥ */
              // –Ω–æ —á—Ç–æ–±—ã –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å React-children –¥–ª—è –∫–∞–∂–¥–æ–π, –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º innerHTML –æ—Ç staticSvgs
              // ‚Äî —Ç–µ–º –Ω–µ –º–µ–Ω–µ–µ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –≤—Å—Ç–∞–≤–ª—è–µ–º React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤ useEffect –ø–æ–¥–ø–∏—à–µ—Ç—Å—è –Ω–∞ staticSvgs:
              React.createElement( GiftPlaceholder, { giftIndex: idx, staticSvgs } )
            );
          })
        )
      );
    }

    /* ========== GiftPlaceholder: –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤—Å—Ç–∞–≤–ª—è–µ—Ç static svg (freeze) ========== */
    function GiftPlaceholder({ giftIndex, staticSvgs }) {
      const ref = useRef(null);
      useEffect(() => {
        const el = ref.current;
        if (!el) return;
        el.innerHTML = ""; // –æ—á–∏—Å—Ç–∫–∞
        if (staticSvgs && staticSvgs[giftIndex]) {
          el.innerHTML = staticSvgs[giftIndex];
        } else {
          el.textContent = '';
        }
      }, [giftIndex, staticSvgs]);
      return React.createElement('div', { ref, style: { width: ITEM_SIZE + 'px', height: ITEM_SIZE + 'px' } });
    }

    /* ========== App ========== */
    function App() {
      const [loading, setLoading] = useState(true);
      const [staticSvgs, setStaticSvgs] = useState({});
      const [spinDisabled, setSpinDisabled] = useState(true);
      const [spinning, setSpinning] = useState(false);
      const [finalIndices, setFinalIndices] = useState([null, null, null]);
      const machineRef = useRef(null);
      const machineAnimRef = useRef(null);

      // –°—á—ë—Ç—á–∏–∫ –æ—Å—Ç–∞–Ω–æ–≤–∏–≤—à–∏—Ö—Å—è –±–∞—Ä–∞–±–∞–Ω–æ–≤
      const stoppedCountRef = useRef(0);

      useEffect(() => {
        let cancelled = false;
        async function preloadAll() {
          // –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–µ –∫–∞–¥—Ä—ã (freeze) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ gift
          const map = {};
          for (let i = 0; i < gifts.length; i++) {
            try {
              map[i] = await preloadLottieFreeze(gifts[i].file);
            } catch (e) {
              map[i] = `<div style="color:#000;padding:6px">error</div>`;
            }
            if (cancelled) return;
          }
          setStaticSvgs(map);
          setLoading(false);
          setSpinDisabled(false);
        }
        preloadAll();
        return () => { cancelled = true; };
      }, []);

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∞ (–∏–≥—Ä–∞–µ–º 1 —Ä–∞–∑ –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–ø–∏–Ω–µ)
      useEffect(() => {
        if (!machineRef.current) return;
        machineAnimRef.current = lottie.loadAnimation({
          container: machineRef.current,
          renderer: "svg",
          loop: false,
          autoplay: false,
          path: "./assets/777.json"
        });
        return () => {
          try { machineAnimRef.current && machineAnimRef.current.destroy(); } catch(e) {}
        };
      }, []);

      // callback –æ—Ç Reel –æ —Ç–æ–º, —á—Ç–æ –æ–Ω –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è
      function onReelStopped(index) {
        stoppedCountRef.current += 1;
        // –∫–æ–≥–¥–∞ –≤—Å–µ 3 –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å ‚Äî –∑–∞–≤–µ—Ä—à–∞–µ–º —Å–ø–∏–Ω
        if (stoppedCountRef.current >= 3) {
          setSpinning(false);
          stoppedCountRef.current = 0;
          // –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–∏–≥—Ä—ã—à–∞
          if (finalIndices[0] != null && finalIndices[1] != null && finalIndices[2] != null) {
            if (finalIndices[0] === finalIndices[1] && finalIndices[1] === finalIndices[2]) {
              // –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –æ–∫–Ω–æ/—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Äî –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ console + toast
              setTimeout(() => {
                alert(`üéâ –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏: ${gifts[ finalIndices[0] ].name } ‚Äî —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–æ–º –¥–ª—è –≤—Ä—É—á–µ–Ω–∏—è NFT.`);
              }, 200);
            }
          }
        }
      }

      // –ù–∞–∂–∞–ª–∏ Spin
      function handleSpin() {
        if (spinDisabled || spinning || loading) return;
        // —Å–ª—É—á–∞–π–Ω—ã–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã (0..gifts.length-1)
        const results = [
          Math.floor(Math.random() * gifts.length),
          Math.floor(Math.random() * gifts.length),
          Math.floor(Math.random() * gifts.length)
        ];
        setFinalIndices(results);
        setSpinning(true);
        // –∏–≥—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∞–≤—Ç–æ–º–∞—Ç–∞ –æ–¥–∏–Ω —Ä–∞–∑
        try {
          if (machineAnimRef.current) {
            machineAnimRef.current.goToAndStop(0, true);
            machineAnimRef.current.play();
          }
        } catch (e) { console.warn(e); }
      }

      // –í—ã—á–∏—Å–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫–∏, –∫–æ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞—Ç—å —Ç–æ—Ä–º–æ–∑–∏—Ç—å (–º—ã —Ö–æ—Ç–∏–º, —á—Ç–æ–±—ã –ø–µ—Ä–µ—Ö–æ–¥ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è –≤ REEL_STOP_TIMES)
      // startStopDelay = stopFinishTime - TRANSITION_MS
      const stopStartDelays = REEL_STOP_TIMES.map(t => Math.max(0, t - TRANSITION_MS));

      return React.createElement('div', { className: 'app' },
        loading && React.createElement('div', { className: 'loading' }, React.createElement('div', null, 'Loading assets...')),
        React.createElement('div', { className: 'machine-wrap' },
          // –±–∞—Ä–∞–±–∞–Ω—ã
          React.createElement('div', { className: 'reels' },
            [0,1,2].map(i => React.createElement(Reel, {
              key: i,
              reelIndex: i,
              spinning,
              finalGiftIndex: finalIndices[i],
              staticSvgs,
              stopStartDelay: stopStartDelays[i],
              onReelStopped
            }))
          ),
          // –∞–≤—Ç–æ–º–∞—Ç –ø–æ–≤–µ—Ä—Ö –±–∞—Ä–∞–±–∞–Ω–æ–≤
          React.createElement('div', { className: 'machine-lottie', ref: machineRef })
        ),
        React.createElement('div', null,
          React.createElement('button', {
            className: 'spin-btn',
            onClick: handleSpin,
            disabled: spinDisabled || spinning || loading
          }, spinning ? '–ö—Ä—É—Ç–∏–º...' : 'Spin üé∞')
        ),
        React.createElement('div', { className: 'toast' },
          React.createElement('div', null, '–¢–µ—Å—Ç–æ–≤—ã–µ –ø–æ–¥–∞—Ä–∫–∏: Desk Calendar, B-Day Candle, Lol Pop (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è Lottie-json, freeze-frame –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏).')
        )
      );
    }

    // –ú–æ–Ω—Ç–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));

  })();
  </script>
</body>
</html>
